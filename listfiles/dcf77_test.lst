                ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                ;~~  [MyCA] Macro Cross Assembler V1.10 for MyCPU, (c) 2023 by Dennis Kuschel  ~~
                ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

                ;[File: dcf77_test.asm]
                ;[ASCII]
                ;******************************************
                ;****  DCF77 Library - Test program *******
                ;******************************************
                ;****  by Robin Tönniges (2016-2024)  *****
                ;******************************************
                
                ;***********************************************
                ;*Parameter:
                ;*Nothing = Set system clock with DCF77 - Data
                ;*Number 1-7 = Display data set 1-7 from the library
                ;*Number 99 = Display current time and date
                ;*
                ;*
                ;*
                ;***********************************************
                
                ;Include
                ;[File: C:\Program Files (x86)\myca\include\program.hsm]
                ;[ASCII]
                
                ORG 8000h
    8000 0280    DW 8002h
    8002 5B80    DW main
    8004 0000    DW 0
    8006 5B80    DW codestart
                
                ;[File: dcf77_test.asm]
                ;[File: C:\Program Files (x86)\myca\include\ctype.hsm]
                ;[ASCII]
                
                KERN_ISPRINTABLE    EQU 024Eh
                KERN_ISCTRLCHAR     EQU 0250h
                KERN_ISALPHA        EQU 0252h
                KERN_ISDIGIT        EQU 0254h
                KERN_ASCIIPETSCII   EQU 0256h
                KERN_STRING2NUMBER  EQU 0262h
                
                ;[File: dcf77_test.asm]
                ;[File: C:\Program Files (x86)\myca\include\conio.hsm]
                ;[ASCII]
                
                ;-- functions --
                KERN_KBHIT          EQU 023Ah
                KERN_GETCH          EQU 023Ch
                KERN_UNGETCH        EQU 023Eh
                KERN_TESTCTRLC      EQU 0240h
                KERN_PRINTCHAR      EQU 0242h
                KERN_PRINTSTR       EQU 0244h
                KERN_PRINTSTRR      EQU 0246h
                KERN_GETCRSRPOS     EQU 0248h
                KERN_GETSCREENSIZE  EQU 024Ah
                KERN_GETFREELINES   EQU 024Ch
                KERN_INPUT          EQU 0258h
                KERN_PRINTHEX       EQU 025Eh
                KERN_PRINTDEZ       EQU 0260h
                KERN_SETCONSOLE     EQU 022Ch
                KERN_GSTERMINAL     EQU 02A0h
                KERN_QUOTEMODE      EQU 02E6h
                KERN_GSSTDOUTVECT   EQU 02D4h
                KERN_SETINPSPVECT   EQU 025Ah
                KERN_SETINPUTMODE   EQU 025Ch
                
                ;-- flag definitions --
                CON_DISP_LCD        SET 01h
                CON_DISP_SCREEN     SET 02h
                CON_DISP_TTY        SET 03h
                CON_DISP_TTYSCR     SET 04h
                CON_DISP_NONE       SET 0Fh
                CON_KEYB_KEYB       SET 10h
                CON_KEYB_TTY        SET 20h
                CON_KEYB_NONE       SET 0F0h
                INPMODE_BASIC       SET 0
                INPMODE_BASICRUN    SET 1
                INPMODE_KERNALSHELL SET 2
                INPUTFLAG_HISTORY   SET 01h
                INPUTFLAG_SIZE      SET 02h
                INPUTFLAG_QUOTE     SET 04h
                INPUTFLAG_LINE80    SET 08h
                INPUTFLAG_TABKEY    SET 10h
                INPUTFLAG_NOBORDER  SET 20h
                
                ;[File: dcf77_test.asm]
                ;[File: C:\Program Files (x86)\myca\include\time.hsm]
                ;[ASCII]
                
                KERN_GETSETTIME     EQU 029Ah
                KERN_GETSETDATE     EQU 029Ch
                
                KERN_INSDELTIMER    EQU 02AAh
                
                ;[File: dcf77_test.asm]
                ;[File: C:\Program Files (x86)\myca\include\code.hsm]
                ;[ASCII]
                
                KERN_ADAPTOPCODES   EQU 02C4h
                KERN_EXECUTEFILE    EQU 02BEh
                KERN_EXITTSR        EQU 02C2h
                KERN_KILLPROGRAM    EQU 02C0h
                KERN_KILLPROGEX     EQU 0328h
                KERN_SPECROMCALL    EQU 02B6h
                KERN_CALLFROMROM    EQU 02B8h
                KERN_CALLROM        EQU 02BAh
                KERN_LIBCALL        EQU 02CAh
                KERN_LIBSELECT      EQU 02CCh
                KERN_LIBDESELECT    EQU 02CEh
                KERN_LIBUNLOAD      EQU 02D0h
                KERN_ISLOADED       EQU 02D2h
                KERN_ASSERT         EQU 0326h
                
                REG_ROMPAGE  SET 3900h
                
                ;[File: dcf77_test.asm]
                ;Declare variables
                DCF77LIB        EQU 60h
                
                ZP_paramPtr     EQU 10h
                
    8008 D35953 STR_done        DB "System clock successfully set!",0
    800B 54454D 
    800E 20434C 
    8011 4F434B 
    8014 205355 
    8017 434345 
    801A 535346 
    801D 554C4C 
    8020 592053 
    8023 455421 
    8026 00     
    8027 D24543 STR_fault       DB "Receiver not synchronized or data incomplete!",0
    802A 454956 
    802D 455220 
    8030 4E4F54 
    8033 205359 
    8036 4E4348 
    8039 524F4E 
    803C 495A45 
    803F 44204F 
    8042 522044 
    8045 415441 
    8048 20494E 
    804B 434F4D 
    804E 504C45 
    8051 544521 
    8054 00     
                
    8055 00     VAR_seconds     DB 0
    8056 00     VAR_minutes     DB 0
    8057 00     VAR_hours       DB 0
    8058 00     VAR_day         DB 0
    8059 00     VAR_month       DB 0
    805A 00     VAR_year        DB 0
                
                ;--------------------------------------------------------- 
                ;Main program  
                ;---------------------------------------------------------
                codestart
                
                main    
    805B 3C10           FLG ZP_paramPtr ;Initialize zeropointer
                
                ;Get parameter from console
    805D EA     skipPar LPA
    805E 19A580         JPZ setSysTime	;No parameter -> set system clock
    8061 7020           CMP #20h ;Search for "space" -> ' '
    8063 185D80         JNZ skipPar
                
    8066 6F10   _skp0   SPT ZP_paramPtr
    8068 EA             LPA
    8069 19A580         JPZ setSysTime  ;No parameter -> set system clock
    806C 7020           CMP #20h
    806E 196680         JPZ _skp0
                
    8071 5F10           LPT ZP_paramPtr
    8073 1B6202         JSR (KERN_STRING2NUMBER)
    8076 7063           CMP #99
    8078 190E81         JPZ printTime   ;Parameter '99' -> print date/time
    807B 7008   		CMP #8
    807D 08     		PHA
    807E 199480 		JPZ getMet
                
                ;Parameter 0-7 -> Print data from library        
    8081 3060           LDA #DCF77LIB
    8083 1BCC02         JSR  (KERN_LIBSELECT)        
    8086 0C             PLA
    8087 1BCA02         JSR (KERN_LIBCALL)
    808A 179B81         JPC printFault
    808D 2D             CLX
    808E 2E             CLY
    808F 1B6002         JSR (KERN_PRINTDEZ)
    8092 2C             CLA
    8093 1F             RTS
                
                ;Parameter 8 -> Print meteo data from library 
    8094 3060   getMet  LDA #DCF77LIB
    8096 1BCC02         JSR (KERN_LIBSELECT)        
    8099 0C             PLA
    809A 1BCA02         JSR (KERN_LIBCALL)
    809D 179B81         JPC printFault
    80A0 1B4402         JSR (KERN_PRINTSTR)
    80A3 2C             CLA
    80A4 1F             RTS  
                
                setSysTime
    80A5 3060           LDA #DCF77LIB
    80A7 1BCC02         JSR  (KERN_LIBSELECT) 
    80AA 3001           LDA #1 ;Seconds
    80AC 1BCA02         JSR (KERN_LIBCALL)
    80AF 179B81         JPC printFault
    80B2 425580         STAA VAR_seconds
    80B5 3002           LDA #2 ;Minutes
    80B7 1BCA02         JSR (KERN_LIBCALL)
    80BA 179B81         JPC printFault
    80BD 425680         STAA VAR_minutes
    80C0 3003           LDA #3 ;Hours
    80C2 1BCA02         JSR (KERN_LIBCALL)
    80C5 179B81         JPC printFault
    80C8 425780         STAA VAR_hours
    80CB 3004           LDA #4 ;Day
    80CD 1BCA02         JSR (KERN_LIBCALL)
    80D0 179B81         JPC printFault
    80D3 425880         STAA VAR_day
    80D6 3006           LDA #6 ;Month
    80D8 1BCA02         JSR (KERN_LIBCALL)
    80DB 179B81         JPC printFault
    80DE 425980         STAA VAR_month
    80E1 3007           LDA #7 ;Year
    80E3 1BCA02         JSR (KERN_LIBCALL)
    80E6 179B81         JPC printFault
    80E9 425A80         STAA VAR_year
                
                        ;Set system clock
    80EC 325780         LDAA VAR_hours
    80EF 525680         LDXA VAR_minutes
    80F2 595580         LDYA VAR_seconds
    80F5 05             SEC
    80F6 1B9A02         JSR (KERN_GETSETTIME)
                
    80F9 325880         LDAA VAR_day
    80FC 525980         LDXA VAR_month
    80FF 595A80         LDYA VAR_year
    8102 05             SEC
    8103 1B9C02         JSR (KERN_GETSETDATE)
                
    8106 6C0880         LPT #STR_done
    8109 1B4402         JSR (KERN_PRINTSTR)
    810C 2C             CLA
    810D 1F             RTS
                
                printTime
    810E 3060           LDA #DCF77LIB
    8110 1BCC02         JSR  (KERN_LIBSELECT) 
    8113 3003           LDA #3 ;Hours
    8115 1BCA02         JSR (KERN_LIBCALL)
    8118 179B81         JPC printFault
    811B 1A8B81         JSR leadingZero
    811E 2D             CLX
    811F 2E             CLY
    8120 1B6002         JSR (KERN_PRINTDEZ)
    8123 303A           LDA #':'
    8125 1B4202         JSR (KERN_PRINTCHAR)
    8128 3002           LDA #2 ;Minutes
    812A 1BCA02         JSR (KERN_LIBCALL)
    812D 179B81         JPC printFault
    8130 1A8B81         JSR leadingZero
    8133 2D             CLX
    8134 2E             CLY
    8135 1B6002         JSR (KERN_PRINTDEZ)
    8138 303A           LDA #':'
    813A 1B4202         JSR (KERN_PRINTCHAR)
    813D 3001           LDA #1 ;Seconds
    813F 1BCA02         JSR (KERN_LIBCALL)
    8142 179B81         JPC printFault
    8145 1A8B81         JSR leadingZero
    8148 2D             CLX
    8149 2E             CLY
    814A 1B6002         JSR (KERN_PRINTDEZ)
    814D 300D           LDA #13 ;\r
    814F 1B4202         JSR (KERN_PRINTCHAR)
    8152 3004           LDA #4 ;Day
    8154 1BCA02         JSR (KERN_LIBCALL)
    8157 179B81         JPC printFault
    815A 1A8B81         JSR leadingZero
    815D 2D             CLX
    815E 2E             CLY
    815F 1B6002         JSR (KERN_PRINTDEZ)
    8162 302E           LDA #'.'
    8164 1B4202         JSR (KERN_PRINTCHAR)
    8167 3006           LDA #6 ;Month
    8169 1BCA02         JSR (KERN_LIBCALL)
    816C 179B81         JPC printFault
    816F 1A8B81         JSR leadingZero
    8172 2D             CLX
    8173 2E             CLY
    8174 1B6002         JSR (KERN_PRINTDEZ)
    8177 302E           LDA #'.'
    8179 1B4202         JSR (KERN_PRINTCHAR)
    817C 3007           LDA #7 ;Year
    817E 1BCA02         JSR (KERN_LIBCALL)
    8181 179B81         JPC printFault
    8184 2D             CLX
    8185 2E             CLY
    8186 1B6002         JSR (KERN_PRINTDEZ)
    8189 2C             CLA
    818A 1F             RTS
                
                ;--------------------------------------------------------- 
                ;Helper functions   
                ;---------------------------------------------------------
                
                ;Print leading zero for date and time <10
                leadingZero
    818B 08             PHA
    818C 04             CLC
    818D 9009           SBC #9
    818F 179981         JPC lz_0 
    8192 3030           LDA #'0'
    8194 1B4202         JSR (KERN_PRINTCHAR)
    8197 0C             PLA ;<10
    8198 1F             RTS
    8199 0C     lz_0    PLA ;>9
    819A 1F             RTS
                
                printFault
    819B 6C2780         LPT #STR_fault
    819E 1B4402         JSR (KERN_PRINTSTR)
                
    81A1 2C     _RTS    CLA
    81A2 1F             RTS
                


Segment Table:
**************
Segment Name                 Startaddr  Endaddr     Size  Type
=========================================================================
default                           8000     81A2      1A3  CODE  fixed
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

No errors found.
